<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="manifest" href="manifest.json">
<title>Science & AI Brief</title>
<style>
:root{--bg:#0f1115;--panel:#111524;--card:#151a28;--line:#262c3d;--ink:#ecf1fa;--muted:#9fb0c9;--accent:#79b8ff;--green:#32d296;--red:#ff6b6b}
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
header{position:sticky;top:0;background:rgba(17,21,36,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--line);z-index:10}
.wrap{max-width:1100px;margin:0 auto;padding:12px}
.top{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
h1{margin:0;font-size:18px}
#stamp{margin-left:auto;color:var(--muted);font-size:12px}
.status{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:4px 10px;font-size:12px}
.status .dot{width:8px;height:8px;border-radius:50%}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.tabs{display:flex;gap:8px;overflow:auto;padding:4px 0}
.tab{border:1px solid var(--line);background:#0e1322;color:#dbe6ff;padding:6px 10px;border-radius:999px;cursor:pointer;white-space:nowrap;font-size:13px}
.tab.active{outline:2px solid var(--accent)}
input[type="search"]{flex:1;min-width:200px;border:1px solid var(--line);background:#0e1220;color:var(--ink);border-radius:10px;padding:8px 10px}
select,button.toggle{border:1px solid var(--line);background:#0e1220;color:var(--ink);border-radius:10px;padding:8px 10px}
button.toggle.active{outline:2px solid var(--accent)}
main{max-width:1100px;margin:0 auto;padding:14px}
.count{color:var(--muted);font-size:13px;margin:4px 6px 10px}
h2{margin:16px 6px 8px;font-size:15px;color:#cfe3ff}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:10px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
.title{font-weight:650;margin:4px 0 6px}
.title a{color:var(--accent);text-decoration:none}
.meta{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:12px}
.badge{border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px}
.badge.peer{color:#b8ffd1;border-color:#2a6}
.sum{color:#eef2fb;font-size:14px;margin:6px 0}
.bul{margin:8px 0 0 16px;color:#d6deea;font-size:13px}
/* Compact */
body.compact .grid{grid-template-columns:1fr}
body.compact .card{padding:10px}
body.compact .sum, body.compact .bul{display:none}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <h1>🔬 Science & AI Brief</h1>
      <div class="status" id="status">
        <span class="dot" style="background:var(--red)"></span><span>status</span>
      </div>
      <div id="stamp">loading…</div>
    </div>
    <div class="controls">
      <div id="tabs" class="tabs"></div>
      <input id="q" type="search" placeholder="Search…" />
      <select id="sort">
        <option value="new">Newest</option>
        <option value="score">Top score</option>
      </select>
      <button id="peer" class="toggle" title="Peer-reviewed only">Peer-reviewed</button>
      <button id="hi" class="toggle" title="Show top N by score">Highlights</button>
      <button id="cmp" class="toggle" title="Compact list view">Compact</button>
    </div>
  </div>
</header>

<main>
  <div class="count" id="count"></div>
  <div id="content"></div>
  <div style="color:#9fb0c9;text-align:center;padding:14px">
    <a href="daily.csv" style="color:#9fd0ff">CSV</a> •
    <a href="feed.xml" style="color:#9fd0ff">RSS</a> •
    <a href="daily.json" style="color:#9fd0ff">JSON</a> •
    <a href="archive.html" style="color:#9fd0ff">Archive</a>
  </div>
</main>

<script>
const S = { data:null, active:"All", query:"", sort:"new", peer:false, hi:false, hiN:12, compact:false, flat:[] };
const el = {
  tabs: document.getElementById('tabs'),
  q: document.getElementById('q'),
  sort: document.getElementById('sort'),
  peer: document.getElementById('peer'),
  hi: document.getElementById('hi'),
  cmp: document.getElementById('cmp'),
  count: document.getElementById('count'),
  stamp: document.getElementById('stamp'),
  content: document.getElementById('content'),
  status: document.getElementById('status')
};

function save(){ localStorage.setItem('brief_state', JSON.stringify({a:S.active,q:S.query,s:S.sort,p:S.peer,h:S.hi,c:S.compact})) }
function load(){ try{ const v=JSON.parse(localStorage.getItem('brief_state')||'{}'); S.active=v.a||"All"; S.query=v.q||""; S.sort=v.s||"new"; S.peer=!!v.p; S.hi=!!v.h; S.compact=!!v.c; }catch(e){} }
function setHash(){ location.hash = encodeURIComponent(JSON.stringify({a:S.active,q:S.query,s:S.sort,p:S.peer,h:S.hi,c:S.compact})) }
function getHash(){ if(location.hash.length>1){ try { const v = JSON.parse(decodeURIComponent(location.hash.slice(1))); Object.assign(S, {active:v.a??S.active, query:v.q??S.query, sort:v.s??S.sort, peer:!!v.p, hi:!!v.h, compact:!!v.c}); } catch {} } }

load(); getHash();

Promise.all([
  fetch('daily.json?t='+Date.now()).then(r=>r.json()),
  fetch('status.json?t='+Date.now()).then(r=>r.json()).catch(()=>({ok:false}))
]).then(([d,st])=>{
  S.data = d; S.flat = flatten(d);
  el.stamp.textContent = "Updated " + new Date(d.generated_at).toLocaleString();

  // Status pill
  const dot = el.status.querySelector('.dot');
  const label = el.status.querySelector('span:nth-child(2)');
  if(st && st.ok){
    dot.style.background = 'var(--green)';
    label.textContent = `ok • ${new Date(st.ts_unix*1000).toLocaleString()}`;
  } else {
    dot.style.background = 'var(--red)';
    label.textContent = 'error';
  }

  buildTabs(d); bind(); render();
}).catch(()=>{
  el.stamp.textContent = "Offline or failed to load.";
});

function flatten(d){ const out=[]; for(const g of d.groups){ for(const it of g.items){ out.push({...it, category:g.category}); } } return out; }

function buildTabs(d){
  el.tabs.innerHTML = "";
  const counts = {};
  d.groups.forEach(g => counts[g.category] = (g.items||[]).length);
  const cats = ["All", ...d.groups.map(g=>g.category)];
  for(const c of cats){
    const n = (c==="All") ? S.flat.length : (counts[c]||0);
    const b = document.createElement('button');
    b.className = 'tab' + (c===S.active?' active':'');
    b.textContent = `${c} (${n})`;
    b.onclick = () => { S.active=c; save(); setHash(); render(); Array.from(el.tabs.children).forEach(x=>x.classList.remove('active')); b.classList.add('active'); };
    el.tabs.appendChild(b);
  }
  el.q.value=S.query; el.sort.value=S.sort;
  el.peer.classList.toggle('active', S.peer);
  el.hi.classList.toggle('active', S.hi);
  el.cmp.classList.toggle('active', S.compact);
  document.body.classList.toggle('compact', S.compact);
}

function bind(){
  el.q.addEventListener('input', debounce(()=>{ S.query=el.q.value.trim().toLowerCase(); save(); setHash(); render(); }, 200));
  el.sort.addEventListener('change', ()=>{ S.sort=el.sort.value; save(); setHash(); render(); });
  el.peer.addEventListener('click', ()=>{ S.peer=!S.peer; el.peer.classList.toggle('active', S.peer); save(); setHash(); render(); });
  el.hi.addEventListener('click', ()=>{ S.hi=!S.hi; el.hi.classList.toggle('active', S.hi); save(); setHash(); render(); });
  el.cmp.addEventListener('click', ()=>{ S.compact=!S.compact; el.cmp.classList.toggle('active', S.compact); document.body.classList.toggle('compact', S.compact); save(); setHash(); render(); });
  window.addEventListener('hashchange', ()=>{ getHash(); document.body.classList.toggle('compact', S.compact); render(); });
}

function filtered(){
  let arr = S.flat.slice();
  if(S.active!=="All") arr = arr.filter(it=>it.category===S.active);
  if(S.peer) arr = arr.filter(it=>it.peer_reviewed);
  if(S.query){
    const q=S.query;
    arr = arr.filter(it => (it.title||"").toLowerCase().includes(q) || (it.summary||"").toLowerCase().includes(q) || (it.summary_raw||"").toLowerCase().includes(q));
  }
  if(S.sort==="new"){ arr.sort((a,b)=>(b.published_ts||0)-(a.published_ts||0)); }
  else { arr.sort((a,b)=>(b.score||0)-(a.score||0)); }
  if(S.hi){ arr = arr.slice(0, S.hiN); }
  return arr;
}

function render(){
  const items = filtered();
  el.count.textContent = `${items.length} result${items.length!==1?'s':''}`
    + (S.active!=='All'?` in ${S.active}`:'')
    + (S.peer?' • peer-reviewed':'')
    + (S.hi?` • highlights(${S.hiN})`:'')
    + (S.query?` • “${S.query}”`:'');
  if(items.length===0){ el.content.innerHTML = `<div class="card">No matches. Clear search or toggle filters.</div>`; return; }
  const byCat={}; for(const it of items){ (byCat[it.category] ||= []).push(it); }
  const frag=document.createDocumentFragment();
  Object.keys(byCat).sort((a,b)=>a.localeCompare(b)).forEach(c=>{
    const h=document.createElement('h2'); h.textContent=c; frag.appendChild(h);
    const grid=document.createElement('div'); grid.className='grid';
    byCat[c].forEach(it=>grid.appendChild(card(it)));
    frag.appendChild(grid);
  });
  el.content.innerHTML=''; el.content.appendChild(frag);
}

function card(it){
  const wrap=document.createElement('article'); wrap.className='card';
  const meta=document.createElement('div'); meta.className='meta';
  const peer = it.peer_reviewed ? `<span class="badge peer">peer-reviewed</span>` : '';
  meta.innerHTML = `${peer} <span>${escape(it.source_domain||"")}</span> <span>•</span> <span>${it.published_ts? new Date(it.published_ts*1000).toLocaleDateString():''}</span>`;
  const title=document.createElement('div'); title.className='title';
  title.innerHTML=`<a target="_blank" rel="noopener" href="${it.link}">${escape(it.title||"")}</a>`;
  const sum=document.createElement('div'); sum.className='sum'; sum.textContent=it.summary||it.summary_raw||"";
  const ul=document.createElement('ul'); ul.className='bul';
  ul.innerHTML = [
    `<li><strong>What’s new:</strong> ${escape(it.why_new||"")}</li>`,
    `<li><strong>Why it matters:</strong> ${escape(it.why_matters||"")}</li>`,
    `<li><strong>Caveats:</strong> ${escape(it.caveats||"")}</li>`
  ].join("");
  wrap.append(meta,title,sum,ul);
  return wrap;
}

function escape(s){return String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]))}
function debounce(fn,ms){let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
if("serviceWorker" in navigator){ navigator.serviceWorker.register("./sw.js").catch(()=>{}); }
</script>
</body>
</html>

