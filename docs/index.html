<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Science & AI Brief</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root { --bg:#0f1115; --card:#161922; --ink:#e8ebf2; --muted:#aab3c2; --line:#242a36; --accent:#77b7ff; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--ink); font: 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    header { position:sticky; top:0; z-index:2; background:rgba(15,17,21,.7); backdrop-filter:saturate(1.2) blur(8px); border-bottom:1px solid var(--line); padding:14px 16px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    h1 { margin:0; font-size:18px; }
    #stamp { margin-left:auto; color:var(--muted); font-size:13px; }
    main { padding: 10px 14px 40px; max-width: 980px; margin: 0 auto; }
    h2 { margin: 22px 6px 10px; font-size: 16px; color:#cfe3ff; }
    .card { background: var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; margin:10px 6px; }
    .meta { color:var(--muted); font-size:13px; display:flex; gap:10px; flex-wrap:wrap; }
    .tag  { border:1px solid var(--line); border-radius:999px; padding:2px 8px; font-size:12px; color:#cfe3ff; }
    .title { margin:8px 0; font-weight:650; font-size:16px; line-height:1.35; }
    a { color: var(--accent); text-decoration:none; }
    .summary { color:#e8edf3; margin-top:4px; }
    .bullets { margin:10px 0 0 18px; color:#d6deea; }
    .chips { width:100%; display:flex; gap:8px; flex-wrap:wrap; padding-top:4px; }
    .chip { background:#131722; color:#dbe4ee; border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:13px; cursor:pointer; }
    .chip.active { outline:2px solid var(--accent); }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ”¬ Science & AI Brief</h1>
    <div id="stamp">loadingâ€¦</div>
    <div id="chips" class="chips"></div>
  </header>
  <main id="content"></main>

  <script>
    const S = { data:null, active:new Set() };
    const el = {
      content: document.getElementById('content'),
      chips:   document.getElementById('chips'),
      stamp:   document.getElementById('stamp')
    };

    fetch('daily.json?t=' + Date.now())
      .then(r => r.json())
      .then(data => { S.data = data; el.stamp.textContent = "Updated " + new Date(data.generated_at).toLocaleString(); buildChips(); render(); })
      .catch(() => { el.stamp.textContent = "Offline or failed to load."; });

    function buildChips(){
      el.chips.innerHTML = "";
      for (const g of S.data.groups) {
        const b = document.createElement('button');
        b.className = 'chip';
        b.textContent = g.category;
        b.onclick = () => { toggleChip(g.category, b); };
        el.chips.appendChild(b);
      }
    }
    function toggleChip(cat, button){
      if (S.active.has(cat)) { S.active.delete(cat); button.classList.remove('active'); }
      else { S.active.add(cat); button.classList.add('active'); }
      render();
    }

    function render(){
      el.content.innerHTML = "";
      if(!S.data) return;
      const groups = S.data.groups.filter(g => S.active.size===0 || S.active.has(g.category));
      for (const g of groups) {
        const h = document.createElement('h2');
        h.textContent = g.category;
        el.content.appendChild(h);
        for (const it of g.items) el.content.appendChild(card(g.category, it));
      }
    }

    function card(category, it){
      const wrap = document.createElement('article'); wrap.className='card';
      const meta = document.createElement('div'); meta.className='meta';
      meta.innerHTML = `<span class="tag">${category}</span><span>${it.source_domain||""}</span><span>${it.published_ts? new Date(it.published_ts*1000).toLocaleDateString():""}</span>`;
      const title = document.createElement('div'); title.className='title';
      title.innerHTML = `<a href="${it.link}" target="_blank" rel="noopener">${escapeHtml(it.title)}</a>`;
      const sum = document.createElement('div'); sum.className='summary';
      sum.textContent = it.summary || it.summary_raw || "";
      const ul = document.createElement('ul'); ul.className='bullets';
      ul.innerHTML = [
        `<li><strong>Whatâ€™s new:</strong> ${escapeHtml(it.why_new||"")}</li>`,
        `<li><strong>Why it matters:</strong> ${escapeHtml(it.why_matters||"")}</li>`,
        `<li><strong>Caveats:</strong> ${escapeHtml(it.caveats||"")}</li>`
      ].join("");
      wrap.append(meta, title, sum, ul);
      return wrap;
    }
    function escapeHtml(s){return String(s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]))}
  </script>
</body>
</html>